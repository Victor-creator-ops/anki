<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Flashcards (Versão Local)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Tone.js for sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Quill Editor Styling */
        .ql-container {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .ql-toolbar {
             border-top-left-radius: 0.5rem;
             border-top-right-radius: 0.5rem;
             background-color: #f9fafb;
        }
        .formatted-content ul, .formatted-content ol {
            padding-left: 1.5rem;
        }
        .formatted-content ul {
            list-style-type: disc;
        }
        .formatted-content ol {
            list-style-type: decimal;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <p class="mt-4 text-lg font-medium">Carregando seus dados...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-5xl mb-24">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-600 mb-4 md:mb-0">
                <i class="fas fa-layer-group mr-2"></i>Anki Web Local
            </h1>
            <nav id="main-nav" class="flex flex-wrap justify-center space-x-2 bg-white p-2 rounded-lg shadow-sm">
                <button data-view="home" class="nav-button bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700 transition-all"><i class="fas fa-home mr-1"></i>Início</button>
                <button data-view="create" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-all"><i class="fas fa-plus-circle mr-1"></i>Criar Cartão</button>
                <button data-view="list" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-all"><i class="fas fa-list-ul mr-1"></i>Meus Cartões</button>
                <button data-view="history" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-all"><i class="fas fa-history mr-1"></i>Histórico</button>
                <button data-view="evolution" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-all"><i class="fas fa-chart-line mr-1"></i>Evolução</button>
                <button data-view="settings" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-all"><i class="fas fa-cog mr-1"></i>Configurações</button>
            </nav>
        </header>

        <main>
            <!-- Visão Inicial (Home) -->
            <div id="home-view" class="view">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold mb-4">Bem-vindo(a) ao seu Deck!</h2>
                    <p class="text-gray-600 mb-6">Pronto para começar a estudar? Você tem <span id="card-count" class="font-bold text-indigo-600">0</span> cartões.</p>
                    
                    <div class="border-t pt-6">
                        <h3 class="text-xl font-semibold mb-4">Iniciar um Quiz</h3>
                        <div class="max-w-lg mx-auto space-y-4 text-left">
                            <div>
                                <label for="quiz-filter-type" class="block text-sm font-medium text-gray-700">Tipo de Quiz</label>
                                <select id="quiz-filter-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="random">Aleatório (Todos os cartões)</option>
                                    <option value="by_category">Por Categoria</option>
                                    <option value="most_errors">Revisão (Mais Erradas)</option>
                                </select>
                            </div>
                            <div id="category-filter-wrapper" class="hidden">
                                <label for="quiz-category-filter" class="block text-sm font-medium text-gray-700">Selecione a Categoria</label>
                                <select id="quiz-category-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                            </div>
                            <div>
                                <label for="quiz-size-input" class="block text-sm font-medium text-gray-700">Número de Perguntas</label>
                                <input type="number" id="quiz-size-input" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Deixe em branco para todos" min="1">
                            </div>
                            <div class="text-center pt-2">
                                <button id="start-quiz-btn" class="w-full md:w-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                                    <i class="fas fa-play-circle mr-2"></i>Começar!
                                </button>
                                <p id="quiz-error" class="text-red-500 mt-2 text-sm h-4"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visão de Criação de Cartão -->
            <div id="create-view" class="view hidden">
                 <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center">Criar Novo Cartão</h2>
                    <form id="create-card-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pergunta</label>
                            <div id="question-editor" class="bg-white rounded-lg shadow-sm"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resposta</label>
                            <div id="answer-editor" class="bg-white rounded-lg shadow-sm"></div>
                        </div>
                        <div>
                            <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Área / Categoria</label>
                            <select id="category-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div id="new-category-wrapper" class="hidden">
                            <label for="new-category-input" class="block text-sm font-medium text-gray-700 mb-1">Nome da Nova Categoria</label>
                            <input type="text" id="new-category-input" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Biologia">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105"><i class="fas fa-save mr-2"></i>Salvar Cartão</button>
                    </form>
                </div>
            </div>
            
            <!-- Visão de Histórico -->
            <div id="history-view" class="view hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-4 text-center">Histórico de Desempenho</h2>
                    <div id="history-content">
                        <div id="history-summary" class="text-center mb-8"></div>
                        <div id="charts-section" class="mb-8 grid grid-cols-1 md:grid-cols-5 gap-8 items-center">
                            <div class="md:col-span-2">
                                <h3 class="text-xl font-semibold mb-4 text-indigo-600 text-center">Desempenho Geral</h3>
                                <canvas id="history-pie-chart"></canvas>
                            </div>
                            <div class="md:col-span-3">
                                <h3 class="text-xl font-semibold mb-4 text-indigo-600 text-center">Sucesso por Categoria (%)</h3>
                                <canvas id="history-bar-chart"></canvas>
                            </div>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Detalhes por Categoria</h3>
                        <div id="history-by-category" class="space-y-4"></div>
                    </div>
                    <div id="no-history-message" class="hidden text-center text-gray-500">
                        <p>Nenhum quiz foi completado ainda. Faça seu primeiro quiz para ver seu histórico!</p>
                    </div>
                </div>
            </div>
            
            <!-- Visão de Evolução -->
            <div id="evolution-view" class="view hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-4 text-center">Evolução do Desempenho</h2>
                    <div id="evolution-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="evolution-category-selector" class="block text-sm font-medium text-gray-700">Categoria</label>
                                <select id="evolution-category-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                            </div>
                             <div>
                                <label for="evolution-start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                                <input type="date" id="evolution-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="evolution-end-date" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                                <input type="date" id="evolution-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <div id="evolution-chart-wrapper">
                            <canvas id="evolution-line-chart"></canvas>
                        </div>
                    </div>
                    <div id="no-evolution-message" class="hidden text-center text-gray-500">
                        <p>Não há dados de evolução suficientes. Estude um pouco mais para ver seu progresso ao longo do tempo.</p>
                    </div>
                </div>
            </div>


            <!-- Visão de Listagem de Cartões -->
            <div id="list-view" class="view hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Meus Cartões</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pergunta</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="cards-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visão do Quiz -->
            <div id="quiz-view" class="view hidden">
                <div class="text-center mb-4"><p class="text-lg font-medium">Pergunta <span id="quiz-current-q"></span> de <span id="quiz-total-q"></span></p></div>
                <div id="flashcard" class="card perspective-[1000px] w-full h-80 max-w-2xl mx-auto mb-6">
                    <div class="card-inner relative w-full h-full">
                        <div class="card-front absolute w-full h-full bg-white rounded-xl shadow-lg p-6 flex flex-col justify-center items-center overflow-y-auto no-scrollbar">
                            <p class="text-gray-500 text-sm mb-2 self-start">Pergunta</p>
                            <div id="quiz-question" class="text-xl text-center font-semibold w-full formatted-content"></div>
                        </div>
                        <div class="card-back absolute w-full h-full bg-indigo-500 text-white rounded-xl shadow-lg p-6 flex flex-col justify-center items-center overflow-y-auto no-scrollbar">
                             <p class="text-indigo-200 text-sm mb-2 self-start">Resposta</p>
                            <div id="quiz-answer" class="text-xl text-center font-semibold w-full formatted-content"></div>
                        </div>
                    </div>
                </div>
                <div class="max-w-2xl mx-auto mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sua Resposta (opcional)</label>
                    <div id="user-answer-editor" class="bg-white rounded-lg shadow-sm"></div>
                </div>
                
                <div id="quiz-actions-before-flip" class="flex justify-center space-x-4"><button id="flip-card-btn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-600 transition-transform transform hover:scale-105"><i class="fas fa-sync-alt mr-2"></i>Virar Cartão</button></div>
                <div id="quiz-actions-after-flip" class="hidden flex-col items-center gap-4">
                    <p class="font-semibold">Como você se saiu?</p>
                    <div class="flex justify-center items-center space-x-2 md:space-x-4">
                        <button data-difficulty="correct" class="quiz-eval-btn bg-green-500 text-white font-bold py-3 px-4 md:px-6 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105"><i class="fas fa-check mr-2"></i>Acertei</button>
                        <button data-difficulty="hard" class="quiz-eval-btn bg-orange-500 text-white font-bold py-3 px-4 md:px-6 rounded-lg shadow-md hover:bg-orange-600 transition-transform transform hover:scale-105"><i class="fas fa-brain mr-2"></i>Difícil</button>
                        <button data-difficulty="incorrect" class="quiz-eval-btn bg-red-500 text-white font-bold py-3 px-4 md:px-6 rounded-lg shadow-md hover:bg-red-600 transition-transform transform hover:scale-105"><i class="fas fa-times mr-2"></i>Errei</button>
                        <button id="re-flip-btn" title="Ver Pergunta Novamente" class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-500 transition-transform transform hover:scale-105"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
            </div>

            <!-- Visão do Relatório -->
            <div id="report-view" class="view hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-2 text-center">Relatório do Quiz</h2>
                    <p id="report-summary" class="text-lg text-gray-600 text-center mb-8"></p>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-green-600"><i class="fas fa-thumbs-up mr-2"></i>Pontos Fortes</h3>
                            <div id="report-strengths" class="space-y-3"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-red-600"><i class="fas fa-book-reader mr-2"></i>Áreas para Melhorar</h3>
                            <div id="report-weaknesses" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-semibold mb-4">Detalhes das Respostas</h3>
                        <div id="report-details" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar pr-2"></div>
                    </div>
                    <div class="text-center mt-8"><button id="back-to-home-btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105"><i class="fas fa-arrow-left mr-2"></i>Voltar ao Início</button></div>
                </div>
            </div>

            <!-- Visão de Configurações (Importar/Exportar) -->
            <div id="settings-view" class="view hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-2 text-center">Importar e Exportar</h2>
                    <p class="text-center text-gray-600 mb-6">Salve um backup de todos os seus dados em um arquivo ou carregue dados de um backup.</p>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="export-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-all">
                            <i class="fas fa-download mr-2"></i>Exportar Dados
                        </button>
                        <button id="import-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition-all">
                            <i class="fas fa-upload mr-2"></i>Importar Dados
                        </button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
                    </div>
                </div>
            </div>

        </main>
        
        <footer class="text-center text-gray-500 mt-8 text-sm">
            <p>Todos os dados são salvos localmente no seu navegador.</p>
        </footer>
    </div>
    
    <!-- Pomodoro Timer -->
    <div id="pomodoro-widget" class="fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-2xl w-64 z-20">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-bold">Cronômetro Pomodoro</h4>
            <div>
                <button id="pomodoro-settings-toggle" class="text-gray-500 hover:text-indigo-600 mr-2"><i class="fas fa-cog"></i></button>
                <button id="pomodoro-close-btn" class="text-gray-500 hover:text-red-600"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="pomodoro-settings" class="hidden mb-3 space-y-2 border-t pt-3">
             <div class="flex items-center justify-between text-sm">
                <label for="foco-input">Foco (min):</label>
                <input type="number" id="foco-input" class="w-20 p-1 border-gray-300 rounded-md">
            </div>
            <div class="flex items-center justify-between text-sm">
                <label for="pausa-input">Pausa (min):</label>
                <input type="number" id="pausa-input" class="w-20 p-1 border-gray-300 rounded-md">
            </div>
            <div class="flex items-center justify-between text-sm">
                <label for="descanso-input">Descanso (min):</label>
                <input type="number" id="descanso-input" class="w-20 p-1 border-gray-300 rounded-md">
            </div>
            <button id="pomodoro-save-settings" class="w-full bg-indigo-500 text-white text-xs py-1 rounded-md mt-2 hover:bg-indigo-600">Salvar Tempos</button>
        </div>
        <div id="pomodoro-time" class="text-5xl font-mono text-center py-2 bg-gray-100 rounded">25:00</div>
        <div class="flex justify-around mt-3">
            <button data-mode="pomodoro" class="pomodoro-mode-btn bg-indigo-500 text-white px-2 py-1 text-xs rounded-full shadow">Foco</button>
            <button data-mode="shortBreak" class="pomodoro-mode-btn bg-gray-300 text-gray-700 px-2 py-1 text-xs rounded-full">Pausa</button>
            <button data-mode="longBreak" class="pomodoro-mode-btn bg-gray-300 text-gray-700 px-2 py-1 text-xs rounded-full">Descanso</button>
        </div>
        <div class="flex justify-center space-x-4 mt-3">
            <button id="pomodoro-start-pause" class="text-indigo-600 text-2xl"><i class="fas fa-play"></i></button>
            <button id="pomodoro-reset" class="text-gray-500 text-2xl"><i class="fas fa-redo"></i></button>
        </div>
    </div>
    <button id="pomodoro-open-btn" class="hidden fixed bottom-4 right-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-2xl z-20 flex items-center justify-center hover:bg-indigo-700">
        <i class="fas fa-clock fa-lg"></i>
    </button>

    <!-- Music Player Widget -->
    <div id="music-widget" class="fixed bottom-4 left-4 bg-white rounded-lg shadow-2xl w-80 z-20 transition-all duration-300">
        <div id="music-widget-header" class="flex justify-between items-center p-2 cursor-pointer">
            <h4 class="font-bold text-sm"><i class="fas fa-music mr-2"></i>Música de Fundo</h4>
            <button id="music-toggle-btn" class="text-gray-500"><i class="fas fa-chevron-up"></i></button>
        </div>
        <div id="music-widget-content" class="p-2 border-t hidden">
            <div class="mb-2 aspect-w-16 aspect-h-9">
                <iframe id="youtube-player" width="100%" height="150" src="https://www.youtube.com/embed/jfKfPfyJRdk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div class="flex justify-around">
                <button data-src="https://www.youtube.com/embed/jfKfPfyJRdk" class="music-source-btn bg-indigo-500 text-white text-xs px-3 py-1 rounded-full shadow">Lofi</button>
                <button data-src="https://www.youtube.com/embed/W-fFHeTX70Q" class="music-source-btn bg-gray-300 text-gray-700 text-xs px-3 py-1 rounded-full">Clássica</button>
            </div>
             <p class="text-xs text-gray-500 mt-2 text-center">Clique no play para iniciar a música.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIÁVEIS GLOBAIS ---
        let allCards = [];
        let quizHistory = [];
        let quizSession = {};
        let historyPieChart = null;
        let historyBarChart = null;
        let evolutionLineChart = null;
        let questionEditor, answerEditor, userAnswerEditor;
        const views = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.nav-button');
        const loadingOverlay = document.getElementById('loading-overlay');

        const quillToolbarOptions = [
            [{ 'header': [1, 2, false] }],
            ['bold', 'italic'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ];

        // --- LÓGICA DE DADOS (localStorage) ---
        const LocalStorageAPI = {
            getCards: () => JSON.parse(localStorage.getItem('ankiApp_cards') || '[]'),
            saveCards: (cards) => localStorage.setItem('ankiApp_cards', JSON.stringify(cards)),
            getHistory: () => JSON.parse(localStorage.getItem('ankiApp_history') || '[]'),
            saveHistory: (history) => localStorage.setItem('ankiApp_history', JSON.stringify(history)),
        };

        function loadInitialData() {
            allCards = LocalStorageAPI.getCards();
            quizHistory = LocalStorageAPI.getHistory();
            updateUIOnCardChange();
            loadingOverlay.style.display = 'none';
        }

        // --- INICIALIZAÇÃO DOS EDITORES ---
        function initializeEditors() {
            if (!questionEditor) {
                questionEditor = new Quill('#question-editor', {
                    modules: { toolbar: quillToolbarOptions },
                    theme: 'snow',
                    placeholder: 'Digite a pergunta aqui...'
                });
            }
            if (!answerEditor) {
                answerEditor = new Quill('#answer-editor', {
                    modules: { toolbar: quillToolbarOptions },
                    theme: 'snow',
                    placeholder: 'Digite a resposta aqui...'
                });
            }
            if (!userAnswerEditor) {
                 userAnswerEditor = new Quill('#user-answer-editor', {
                    modules: { toolbar: quillToolbarOptions },
                    theme: 'snow',
                    placeholder: 'Digite sua resposta...'
                });
            }
        }

        // --- NAVEGAÇÃO ENTRE VISÕES ---
        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');

            navButtons.forEach(button => {
                button.classList.remove('bg-indigo-600', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-700');
                if (button.dataset.view === viewId) {
                    button.classList.add('bg-indigo-600', 'text-white');
                }
            });

            if (viewId === 'create' || viewId === 'quiz') {
                initializeEditors();
            }

            if (viewId === 'list') renderCardsList();
            if (viewId === 'create') populateCategoryDropdown();
            if (viewId === 'history') renderHistoryView();
            if (viewId === 'evolution') renderEvolutionView();
            if (viewId === 'home') handleFilterChange();
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => showView(button.dataset.view));
        });
        
        // --- LÓGICA DE CRIAÇÃO DE CARTÃO ---
        const createCardForm = document.getElementById('create-card-form');
        const categorySelect = document.getElementById('category-select');
        const newCategoryWrapper = document.getElementById('new-category-wrapper');
        const newCategoryInput = document.getElementById('new-category-input');

        function getUniqueCategories() {
            const categories = new Set(allCards.map(card => card.category));
            return Array.from(categories).sort((a, b) => a.localeCompare(b));
        }

        function populateCategoryDropdown() {
            const categories = getUniqueCategories();
            categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            categories.forEach(cat => categorySelect.add(new Option(cat, cat)));
            categorySelect.add(new Option('Adicionar nova...', 'add_new'));
        }

        categorySelect.addEventListener('change', () => {
            newCategoryWrapper.classList.toggle('hidden', categorySelect.value !== 'add_new');
            if (categorySelect.value === 'add_new') newCategoryInput.focus();
        });

        createCardForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const question = questionEditor.root.innerHTML;
            const answer = answerEditor.root.innerHTML;
            let category = categorySelect.value === 'add_new' ? newCategoryInput.value.trim() : categorySelect.value;
            
            if (questionEditor.getLength() <= 1 || answerEditor.getLength() <= 1 || !category || category === 'add_new') {
                alert('Todos os campos são obrigatórios.'); return;
            }

            const newCard = { id: Date.now().toString(), question, answer, category };
            allCards.push(newCard);
            LocalStorageAPI.saveCards(allCards);
            
            questionEditor.setText('');
            answerEditor.setText('');
            createCardForm.reset();
            newCategoryWrapper.classList.add('hidden');
            updateUIOnCardChange();
            showView('home');
        });

        function updateUIOnCardChange() {
            document.getElementById('card-count').textContent = allCards.length;
            document.getElementById('start-quiz-btn').disabled = allCards.length === 0;
        }

        // --- LÓGICA DE LISTAGEM E EXCLUSÃO DE CARTÕES ---
        function renderCardsList() {
            const listBody = document.getElementById('cards-list-body');
            listBody.innerHTML = '';
            if (allCards.length === 0) {
                listBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Nenhum cartão criado ainda.</td></tr>';
                return;
            }
            allCards.forEach(card => {
                const tr = document.createElement('tr');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = card.question;
                const questionText = tempDiv.textContent || tempDiv.innerText || "";

                tr.innerHTML = `
                    <td class="px-6 py-4"><div class="text-sm text-gray-900 break-words max-w-xs">${questionText.substring(0, 100)}...</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${card.category}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${card.id}" class="delete-card-btn text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i> Excluir</button>
                    </td>`;
                listBody.appendChild(tr);
            });

            document.querySelectorAll('.delete-card-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const cardId = e.currentTarget.dataset.id;
                    if (confirm('Tem certeza que deseja excluir este cartão?')) {
                        allCards = allCards.filter(c => c.id !== cardId);
                        LocalStorageAPI.saveCards(allCards);
                        renderCardsList();
                        updateUIOnCardChange();
                    }
                });
            });
        }
        
        // --- LÓGICA DO QUIZ ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function calculateErrorScore() {
            const stats = {};
            quizHistory.forEach(quiz => {
                quiz.results.forEach(res => {
                    stats[res.id] = stats[res.id] || { score: 0 };
                    if (res.result === 'incorrect') {
                        stats[res.id].score += 2;
                    } else if (res.result === 'hard') {
                        stats[res.id].score += 1;
                    }
                });
            });
            return stats;
        }
        
        function handleFilterChange() {
            const filterType = document.getElementById('quiz-filter-type').value;
            const categoryWrapper = document.getElementById('category-filter-wrapper');
            const categorySelect = document.getElementById('quiz-category-filter');
            
            if (filterType === 'by_category') {
                const categories = getUniqueCategories();
                categorySelect.innerHTML = '<option value="">-- Selecione --</option>';
                categories.forEach(cat => {
                    categorySelect.add(new Option(cat, cat));
                });
                categoryWrapper.classList.remove('hidden');
            } else {
                categoryWrapper.classList.add('hidden');
            }
        }

        document.getElementById('quiz-filter-type').addEventListener('change', handleFilterChange);

        document.getElementById('start-quiz-btn').addEventListener('click', () => {
            const filterType = document.getElementById('quiz-filter-type').value;
            const quizSizeInput = document.getElementById('quiz-size-input');
            const quizError = document.getElementById('quiz-error');
            quizError.textContent = '';
            
            let potentialCards = [];

            switch(filterType) {
                case 'by_category':
                    const selectedCategory = document.getElementById('quiz-category-filter').value;
                    if (!selectedCategory) {
                        quizError.textContent = 'Por favor, selecione uma categoria.';
                        return;
                    }
                    potentialCards = allCards.filter(card => card.category === selectedCategory);
                    break;
                
                case 'most_errors':
                    const errorScores = calculateErrorScore();
                    potentialCards = [...allCards]
                        .map(card => ({
                            ...card,
                            score: errorScores[card.id] ? errorScores[card.id].score : 0
                        }))
                        .filter(card => card.score > 0)
                        .sort((a, b) => b.score - a.score);
                    break;

                case 'random':
                default:
                    potentialCards = [...allCards];
                    break;
            }
            
            if (potentialCards.length === 0) {
                quizError.textContent = 'Nenhum cartão encontrado para este filtro.';
                return;
            }

            shuffleArray(potentialCards);

            let requestedSize = parseInt(quizSizeInput.value, 10);
            if (isNaN(requestedSize) || requestedSize <= 0) {
                requestedSize = potentialCards.length;
            }

            if (requestedSize > potentialCards.length) {
                requestedSize = potentialCards.length;
            }

            let quizCards = potentialCards.slice(0, requestedSize);

            quizSession = { questions: quizCards, currentIndex: 0, results: [] };
            showView('quiz');
            displayNextQuestion();
        });

        function displayNextQuestion() {
            if (quizSession.currentIndex >= quizSession.questions.length) {
                showReport();
                return;
            }
            const card = quizSession.questions[quizSession.currentIndex];
            document.getElementById('flashcard').classList.remove('flipped');
            if(userAnswerEditor) userAnswerEditor.setText('');
            document.getElementById('quiz-question').innerHTML = card.question;
            document.getElementById('quiz-answer').innerHTML = card.answer;
            document.getElementById('quiz-current-q').textContent = quizSession.currentIndex + 1;
            document.getElementById('quiz-total-q').textContent = quizSession.questions.length;
            document.getElementById('quiz-actions-before-flip').style.display = 'flex';
            document.getElementById('quiz-actions-after-flip').style.display = 'none';
        }

        document.getElementById('flip-card-btn').addEventListener('click', () => {
            document.getElementById('flashcard').classList.add('flipped');
            document.getElementById('quiz-actions-before-flip').style.display = 'none';
            document.getElementById('quiz-actions-after-flip').style.display = 'flex';
        });

        document.getElementById('re-flip-btn').addEventListener('click', () => {
             document.getElementById('flashcard').classList.toggle('flipped');
        });

        function handleAnswer(difficulty) {
            const currentCard = quizSession.questions[quizSession.currentIndex];
            const userAnswerHTML = userAnswerEditor.root.innerHTML;
            const userAnswer = userAnswerEditor.getLength() > 1 ? userAnswerHTML : '';
            quizSession.results.push({ ...currentCard, result: difficulty, userAnswer: userAnswer });
            quizSession.currentIndex++;
            displayNextQuestion();
        }

        document.querySelectorAll('.quiz-eval-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                handleAnswer(e.currentTarget.dataset.difficulty);
            });
        });
        
        // --- LÓGICA DO RELATÓRIO E HISTÓRICO ---
        function showReport() {
            const historyEntry = { 
                date: new Date().toISOString(), 
                results: quizSession.results 
            };
            quizHistory.push(historyEntry);
            LocalStorageAPI.saveHistory(quizHistory);
            renderSingleReport(quizSession.results);
            showView('report');
        }

        function getResultDisplay(result) {
            switch (result) {
                case 'correct': return { text: 'Correta', color: 'text-green-700' };
                case 'hard': return { text: 'Difícil', color: 'text-orange-700' };
                case 'incorrect': return { text: 'Incorreta', color: 'text-red-700' };
                default: return { text: 'N/A', color: 'text-gray-700' };
            }
        }
        
        function renderSingleReport(results) {
            const totalQuestions = results.length;
            const correctAnswers = results.filter(r => r.result === 'correct').length;
            const hardAnswers = results.filter(r => r.result === 'hard').length;
            const successfulAnswers = correctAnswers + hardAnswers;
            
            const accuracy = totalQuestions > 0 ? (successfulAnswers / totalQuestions * 100).toFixed(0) : 0;
            document.getElementById('report-summary').textContent = `Você acertou ${successfulAnswers} de ${totalQuestions} perguntas (${accuracy}%).`;
            
            const categoryStats = {};
            results.forEach(result => {
                if (!categoryStats[result.category]) categoryStats[result.category] = { correct: 0, hard: 0, incorrect: 0, total: 0 };
                categoryStats[result.category][result.result]++;
                categoryStats[result.category].total++;
            });

            const strengthsContainer = document.getElementById('report-strengths');
            const weaknessesContainer = document.getElementById('report-weaknesses');
            const detailsContainer = document.getElementById('report-details');
            strengthsContainer.innerHTML = ''; weaknessesContainer.innerHTML = ''; detailsContainer.innerHTML = '';
            let hasStrengths = false, hasWeaknesses = false;

            Object.entries(categoryStats).forEach(([category, stats]) => {
                const successRate = (stats.correct + stats.hard) / stats.total * 100;
                const statHtml = createStatHTML(category, (stats.correct + stats.hard), stats.total, successRate);
                if (successRate >= 70) { strengthsContainer.innerHTML += statHtml; hasStrengths = true; } 
                else { weaknessesContainer.innerHTML += statHtml; hasWeaknesses = true; }
            });

            if (!hasStrengths) strengthsContainer.innerHTML = '<p class="text-gray-500">Continue estudando!</p>';
            if (!hasWeaknesses) weaknessesContainer.innerHTML = '<p class="text-gray-500">Ótimo trabalho!</p>';
            
            results.forEach(result => {
                const resultDisplay = getResultDisplay(result.result);
                const resultColor = result.result === 'correct' ? 'bg-green-50' : result.result === 'hard' ? 'bg-orange-50' : 'bg-red-50';
                const userAnswerHTML = result.userAnswer 
                    ? `<div class="text-sm text-gray-700 mt-2 border-t pt-2"><strong class="block mb-1">Sua resposta digitada:</strong><div class="formatted-content">${result.userAnswer}</div></div>`
                    : '';

                detailsContainer.innerHTML += `
                    <div class="p-3 rounded-lg ${resultColor}">
                        <div class="font-semibold formatted-content">${result.question}</div>
                        ${userAnswerHTML}
                        <p class="text-sm text-gray-600 mt-2 border-t pt-2">Sua avaliação: <span class="${resultDisplay.color} font-bold">${resultDisplay.text}</span></p>
                        <div class="text-sm text-gray-800 mt-1 "><strong class="block mb-1">Resposta correta:</strong><div class="formatted-content">${result.answer}</div></div>
                    </div>`;
            });
        }

        function renderHistoryView() {
            const noHistoryMsg = document.getElementById('no-history-message');
            const historyContent = document.getElementById('history-content');

            if (historyPieChart) historyPieChart.destroy();
            if (historyBarChart) historyBarChart.destroy();

            if (quizHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
                historyContent.classList.add('hidden');
                return;
            }

            noHistoryMsg.classList.add('hidden');
            historyContent.classList.remove('hidden');

            const overallStats = { correct: 0, hard: 0, incorrect: 0, total: 0 };
            const categoryStats = {};
            quizHistory.forEach(quiz => {
                quiz.results.forEach(res => {
                    if(!res.result) res.result = 'incorrect';
                    overallStats.total++;
                    overallStats[res.result]++;
                    
                    if (!categoryStats[res.category]) categoryStats[res.category] = { correct: 0, hard: 0, incorrect: 0, total: 0 };
                    categoryStats[res.category].total++;
                    categoryStats[res.category][res.result]++;
                });
            });

            const overallSuccess = overallStats.correct + overallStats.hard;
            const overallAccuracy = overallStats.total > 0 ? (overallSuccess / overallStats.total * 100).toFixed(0) : 0;
            document.getElementById('history-summary').innerHTML = `<p class="text-lg text-gray-600">No total, você respondeu <span class="font-bold">${overallStats.total}</span> perguntas com uma taxa de sucesso de <span class="font-bold text-indigo-600">${overallAccuracy}%</span>.</p>`;
            
            renderHistoryCharts(overallStats, categoryStats);
            
            const byCategoryContainer = document.getElementById('history-by-category');
            byCategoryContainer.innerHTML = '';
            Object.entries(categoryStats).sort((a,b) => a[0].localeCompare(b[0])).forEach(([category, stats]) => {
                const successRate = stats.total > 0 ? (stats.correct + stats.hard) / stats.total * 100 : 0;
                byCategoryContainer.innerHTML += createStatHTML(category, (stats.correct + stats.hard), stats.total, successRate);
            });
        }

        function renderHistoryCharts(overallStats, categoryStats) {
            const pieCtx = document.getElementById('history-pie-chart').getContext('2d');
            historyPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Corretas', 'Difíceis', 'Incorretas'],
                    datasets: [{
                        label: 'Desempenho Geral',
                        data: [overallStats.correct, overallStats.hard, overallStats.incorrect],
                        backgroundColor: ['#22c55e', '#f97316', '#ef4444'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });

            const barCtx = document.getElementById('history-bar-chart').getContext('2d');
            const sortedCategories = Object.entries(categoryStats).sort((a,b) => a[0].localeCompare(b[0]));
            
            historyBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: sortedCategories.map(item => item[0]),
                    datasets: [{
                        label: '% de Sucesso',
                        data: sortedCategories.map(item => {
                            const stats = item[1];
                            return stats.total > 0 ? ((stats.correct + stats.hard) / stats.total * 100).toFixed(2) : 0;
                        }),
                        backgroundColor: sortedCategories.map(item => {
                             const stats = item[1];
                             const rate = stats.total > 0 ? (stats.correct + stats.hard) / stats.total * 100 : 0;
                             return rate >= 70 ? 'rgba(34, 197, 94, 0.7)' : rate >= 40 ? 'rgba(249, 115, 22, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderColor: sortedCategories.map(item => {
                             const stats = item[1];
                             const rate = stats.total > 0 ? (stats.correct + stats.hard) / stats.total * 100 : 0;
                             return rate >= 70 ? 'rgb(34, 197, 94)' : rate >= 40 ? 'rgb(249, 115, 22)' : 'rgb(239, 68, 68)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, max: 100, ticks: { callback: function(value) { return value + "%" } } } }
                }
            });
        }

        function createStatHTML(category, success, total, percentage) {
            const bgColor = percentage >= 70 ? '#22c55e' : percentage >= 40 ? '#f59e0b' : '#ef4444';
            return `<div class="bg-gray-100 p-3 rounded-lg"><div class="flex justify-between items-center mb-1"><span class="font-semibold">${category}</span><span class="text-sm font-medium">${success}/${total}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${percentage.toFixed(0)}%; background-color: ${bgColor};"></div></div></div>`;
        }

        // --- LÓGICA DA EVOLUÇÃO ---
        function renderEvolutionView() {
            if (evolutionLineChart) evolutionLineChart.destroy();
            
            const evolutionContent = document.getElementById('evolution-content');
            const noEvolutionMsg = document.getElementById('no-evolution-message');
            const categorySelector = document.getElementById('evolution-category-selector');
            const startDateInput = document.getElementById('evolution-start-date');
            const endDateInput = document.getElementById('evolution-end-date');

            const allHistoryCategories = new Set();
            quizHistory.forEach(quiz => {
                quiz.results.forEach(res => allHistoryCategories.add(res.category));
            });

            if (quizHistory.length === 0) {
                evolutionContent.classList.add('hidden');
                noEvolutionMsg.classList.remove('hidden');
                return;
            }

            evolutionContent.classList.remove('hidden');
            noEvolutionMsg.classList.add('hidden');

            const currentCategory = categorySelector.value;
            categorySelector.innerHTML = '<option value="all">Todas as Categorias</option>';
            Array.from(allHistoryCategories).sort().forEach(cat => {
                const option = new Option(cat, cat);
                categorySelector.add(option);
            });
            categorySelector.value = currentCategory;
            
            const applyFilters = () => {
                renderEvolutionChart(categorySelector.value, startDateInput.value, endDateInput.value);
            };

            categorySelector.onchange = applyFilters;
            startDateInput.onchange = applyFilters;
            endDateInput.onchange = applyFilters;

            applyFilters();
        }

        function renderEvolutionChart(categoryFilter, startDate, endDate) {
            if (evolutionLineChart) evolutionLineChart.destroy();

            let filteredHistory = quizHistory;
            if (startDate) {
                filteredHistory = filteredHistory.filter(quiz => quiz.date.split('T')[0] >= startDate);
            }
            if (endDate) {
                filteredHistory = filteredHistory.filter(quiz => quiz.date.split('T')[0] <= endDate);
            }

            const dailyStats = {};
            filteredHistory.forEach(quiz => {
                const date = quiz.date.split('T')[0];
                dailyStats[date] = dailyStats[date] || { correct: 0, hard: 0, incorrect: 0, total: 0 };
                
                quiz.results.forEach(res => {
                    if (categoryFilter === 'all' || res.category === categoryFilter) {
                        dailyStats[date][res.result]++;
                        dailyStats[date].total++;
                    }
                });
            });

            const sortedDates = Object.keys(dailyStats).filter(date => dailyStats[date].total > 0).sort((a, b) => new Date(a) - new Date(b));

            const labels = sortedDates.map(date => new Date(date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}));
            const correctData = sortedDates.map(date => (dailyStats[date].correct / dailyStats[date].total * 100) || 0);
            const hardData = sortedDates.map(date => (dailyStats[date].hard / dailyStats[date].total * 100) || 0);
            const incorrectData = sortedDates.map(date => (dailyStats[date].incorrect / dailyStats[date].total * 100) || 0);

            const lineCtx = document.getElementById('evolution-line-chart').getContext('2d');
            evolutionLineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '% Corretas',
                            data: correctData,
                            borderColor: '#22c55e',
                            backgroundColor: '#22c55e',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '% Difíceis',
                            data: hardData,
                            borderColor: '#f97316',
                            backgroundColor: '#f97316',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '% Incorretas',
                            data: incorrectData,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) { return value + "%" }
                            }
                        }
                    }
                }
            });
        }


        document.getElementById('back-to-home-btn').addEventListener('click', () => showView('home'));

        // --- LÓGICA DE IMPORTAR E EXPORTAR ---
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file-input');

        function exportData() {
            const dataToExport = {
                cards: LocalStorageAPI.getCards(),
                history: LocalStorageAPI.getHistory()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = `anki_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData.cards) || !Array.isArray(importedData.history)) {
                        throw new Error("Formato do arquivo inválido.");
                    }
                    if (confirm("Isso substituirá todos os seus cartões e histórico atuais. Deseja continuar?")) {
                        LocalStorageAPI.saveCards(importedData.cards);
                        LocalStorageAPI.saveHistory(importedData.history);
                        alert("Dados importados com sucesso! A página será recarregada.");
                        window.location.reload();
                    }
                } catch (error) {
                    alert("Erro ao importar o arquivo. Verifique se o arquivo é um backup válido.\nDetalhes: " + error.message);
                }
            };
            reader.readAsText(file);
            importFileInput.value = '';
        }

        exportBtn.addEventListener('click', exportData);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
        
        // --- LÓGICA DO POMODORO ---
        const pomodoro = {
            widget: document.getElementById('pomodoro-widget'),
            openBtn: document.getElementById('pomodoro-open-btn'),
            closeBtn: document.getElementById('pomodoro-close-btn'),
            timerDisplay: document.getElementById('pomodoro-time'),
            startPauseBtn: document.getElementById('pomodoro-start-pause'),
            resetBtn: document.getElementById('pomodoro-reset'),
            modeBtns: document.querySelectorAll('.pomodoro-mode-btn'),
            settingsToggleBtn: document.getElementById('pomodoro-settings-toggle'),
            settingsDiv: document.getElementById('pomodoro-settings'),
            focoInput: document.getElementById('foco-input'),
            pausaInput: document.getElementById('pausa-input'),
            descansoInput: document.getElementById('descanso-input'),
            saveSettingsBtn: document.getElementById('pomodoro-save-settings'),
            modes: {
                pomodoro: 25,
                shortBreak: 5,
                longBreak: 15,
            },
            currentMode: 'pomodoro',
            timeRemaining: 25 * 60,
            timerId: null,
            isPaused: true,

            updateDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                this.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            },

            start() {
                if (this.isPaused) {
                    this.isPaused = false;
                    this.startPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    this.timerId = setInterval(() => {
                        this.timeRemaining--;
                        this.updateDisplay();
                        if (this.timeRemaining <= 0) {
                            this.pause();
                            this.playSound();
                            alert(`Sessão de ${this.currentMode} finalizada!`);
                        }
                    }, 1000);
                }
            },

            pause() {
                this.isPaused = true;
                this.startPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                clearInterval(this.timerId);
            },
            
            toggleStartPause() {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                if (this.isPaused) {
                    this.start();
                } else {
                    this.pause();
                }
            },

            reset() {
                this.pause();
                this.timeRemaining = this.modes[this.currentMode] * 60;
                this.updateDisplay();
            },

            setMode(mode) {
                this.currentMode = mode;
                this.modeBtns.forEach(btn => {
                    if(btn.dataset.mode === mode) {
                        btn.classList.add('bg-indigo-500', 'text-white');
                        btn.classList.remove('bg-gray-300', 'text-gray-700');
                    } else {
                        btn.classList.remove('bg-indigo-500', 'text-white');
                        btn.classList.add('bg-gray-300', 'text-gray-700');
                    }
                });
                this.reset();
            },
            
            playSound() {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C5", "8n", Tone.now());
                synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
            },
            
            loadSettings() {
                const savedTimes = JSON.parse(localStorage.getItem('pomodoro_times'));
                if (savedTimes) {
                    this.modes.pomodoro = parseInt(savedTimes.pomodoro, 10) || 25;
                    this.modes.shortBreak = parseInt(savedTimes.shortBreak, 10) || 5;
                    this.modes.longBreak = parseInt(savedTimes.longBreak, 10) || 15;
                }
                this.focoInput.value = this.modes.pomodoro;
                this.pausaInput.value = this.modes.shortBreak;
                this.descansoInput.value = this.modes.longBreak;
            },

            saveSettings() {
                this.modes.pomodoro = parseInt(this.focoInput.value, 10) || 25;
                this.modes.shortBreak = parseInt(this.pausaInput.value, 10) || 5;
                this.modes.longBreak = parseInt(this.descansoInput.value, 10) || 15;
                localStorage.setItem('pomodoro_times', JSON.stringify(this.modes));
                alert('Tempos salvos!');
                this.setMode(this.currentMode);
            },
            
            closeWidget() {
                this.widget.classList.add('hidden');
                this.openBtn.classList.remove('hidden');
            },

            openWidget() {
                this.widget.classList.remove('hidden');
                this.openBtn.classList.add('hidden');
            },

            init() {
                this.loadSettings();
                this.startPauseBtn.addEventListener('click', () => this.toggleStartPause());
                this.resetBtn.addEventListener('click', () => this.reset());
                this.modeBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => this.setMode(e.currentTarget.dataset.mode));
                });
                this.settingsToggleBtn.addEventListener('click', () => {
                    this.settingsDiv.classList.toggle('hidden');
                });
                this.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.closeBtn.addEventListener('click', () => this.closeWidget());
                this.openBtn.addEventListener('click', () => this.openWidget());
                this.setMode(this.currentMode);
            }
        };

        pomodoro.init();

        // --- LÓGICA DO WIDGET DE MÚSICA ---
        const musicWidgetHeader = document.getElementById('music-widget-header');
        const musicWidgetContent = document.getElementById('music-widget-content');
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        const youtubePlayer = document.getElementById('youtube-player');
        const musicSourceBtns = document.querySelectorAll('.music-source-btn');

        musicWidgetHeader.addEventListener('click', () => {
            musicWidgetContent.classList.toggle('hidden');
            musicToggleBtn.querySelector('i').classList.toggle('fa-chevron-up');
            musicToggleBtn.querySelector('i').classList.toggle('fa-chevron-down');
        });

        musicSourceBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const newSrc = e.currentTarget.dataset.src;
                youtubePlayer.src = newSrc;

                musicSourceBtns.forEach(b => {
                    b.classList.remove('bg-indigo-500', 'text-white');
                    b.classList.add('bg-gray-300', 'text-gray-700');
                });
                e.currentTarget.classList.add('bg-indigo-500', 'text-white');
                e.currentTarget.classList.remove('bg-gray-300', 'text-gray-700');
            });
        });


        // --- INICIALIZAÇÃO ---
        loadInitialData();
        showView('home');
    });
    </script>
</body>
</html>
